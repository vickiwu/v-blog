# 密钥管理

密钥是你在组织、仓库或仓库环境中创建的变量。你创建的密钥可在 GitHub Actions 工作流中使用。GitHub Actions 只有在你明确将密钥包含在工作流中时才能读取密钥。

GitHub 会从日志中删除密钥，但你仍应小心记录的内容。

敏感密钥应利用环境，因为环境具有保护规则，可用于控制对密钥的访问。这包括可以从哪个分支访问密钥。如果将此与分支保护规则结合使用，你可以创建一个非常安全的系统。

* [使用密钥](https://docs.github.com/zh/actions/security-for-github-actions/security-guides/security-hardening-for-github-actions#using-secrets)

## 可重用工作流和密钥

你必须明确地将密钥传递给可重用工作流。这是因为密钥的作用域限定为调用方工作流。

## OIDC 访问云环境

GitHub Actions 现在可以使用 OIDC 令牌对云环境进行身份验证。这是比使用 PAT 更安全的云环境身份验证方式。

* [关于使用 OpenID Connect 进行安全强化](https://docs.github.com/zh/actions/security-for-github-actions/security-hardening-your-deployments/about-security-hardening-with-openid-connect)

## 与第三方密钥保管库/HSM 集成

市场上有第三方 actions 可让你与密钥保管库和 HSM 集成。

<details>
  <summary>hashicorp/hashicorp-vault</summary>

```yml hljs
jobs:
    build:
        # ...
        steps:
            # ...
            - name: 导入密钥
              id: import-secrets
              uses: hashicorp/vault-action@v2
              with:
                url: https://vault.mycompany.com:8200
                token: ${{ secrets.VAULT_TOKEN }}
                caCertificate: ${{ secrets.VAULT_CA_CERT }}
                secrets: |
                    secret/data/ci/aws accessKey | AWS_ACCESS_KEY_ID ;
                    secret/data/ci/aws secretKey | AWS_SECRET_ACCESS_KEY ;
                    secret/data/ci npm_token
            # ...
```
</details>

<details>
  <summary>Azure/cli</summary>

[快速入门：使用 Azure CLI 从 Azure Key Vault 设置和检索密钥](https://learn.microsoft.com/zh-cn/azure/key-vault/secrets/quick-create-cli)
```yml hljs
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Azure 登录
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Azure CLI 脚本
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          az keyvault secret show --name "ExamplePassword" --vault-name "<your-unique-keyvault-name>" --query "value"
```
</details>

## 最佳实践

1. **使用环境密钥** - 为生产环境使用环境级别的密钥，并配置保护规则
2. **最小权限原则** - 只授予必要的权限
3. **定期轮换** - 定期更新密钥
4. **使用 OIDC** - 对于云服务，优先使用 OIDC 而不是长期凭据
5. **避免在日志中输出** - 永远不要在日志中打印密钥值
