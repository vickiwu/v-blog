# GitHub Actions 概念介绍

理解 GitHub Actions 的几个核心概念非常重要。

![overview-actions-simple](/assets/screenshots/overview-actions-simple.png)

## 基本定义

### [工作流 (Workflow)](https://docs.github.com/zh/actions/about-github-actions/understanding-github-actions#workflows)

工作流是一个可配置的自动化流程，可以运行一个或多个作业。工作流由存储在仓库 `.github/workflows` 目录中的 YAML 文件定义。一个仓库可以有多个工作流，每个工作流可以执行不同的任务集。

### [事件 (Events)](https://docs.github.com/zh/actions/about-github-actions/understanding-github-actions#events)

事件是触发工作流运行的特定活动。它可以由仓库中的事件触发，也可以手动触发或按定义的时间表触发。

### [作业 (Jobs)](https://docs.github.com/zh/actions/about-github-actions/understanding-github-actions#jobs)

作业是工作流中在同一运行器上执行的一组步骤。每个步骤要么是将要执行的 shell 脚本，要么是将要运行的 action。步骤按顺序执行并相互依赖。由于每个步骤都在同一运行器上执行，因此可以在步骤之间共享数据。

### [步骤 / Actions](https://docs.github.com/zh/actions/about-github-actions/understanding-github-actions#actions)

步骤可以是要执行的脚本，也可以是 GitHub action。

### [运行器 (Runners)](https://docs.github.com/zh/actions/about-github-actions/understanding-github-actions#runners)

运行器是在触发工作流时运行工作流的服务器。每个运行器一次可以运行一个作业。

* GHR: GitHub 托管运行器 (GitHub-Hosted Runner)
* SHR: 自托管运行器 (Self-Hosted Runner)

## Action：市场 Action 与自定义 Action

Action 是 GitHub Actions 平台的自定义应用程序，用于执行复杂但经常重复的任务。使用 action 可以减少在工作流文件中编写的重复代码。

Action 可以从 GitHub 拉取 git 仓库，为构建环境设置正确的工具链，或设置云提供商的身份验证。

你可以编写自己的 action，也可以在 [GitHub 市场](https://github.com/marketplace?type=actions) 中找到要在工作流中使用的 action。

更多信息，请参阅 [创建 actions](https://docs.github.com/zh/actions/creating-actions)。

## 运行器：GitHub 托管 vs. 自托管

你可以在 GitHub 托管的计算资源上运行作业，也可以托管自己的自托管运行器。

GitHub 提供的标准运行器有：
* `ubuntu-latest`
* `windows-latest`
* `macos-latest`

还有 [更大的运行器](https://docs.github.com/zh/actions/using-github-hosted-runners/about-larger-runners/about-larger-runners#specifications-for-general-larger-runners) 用于更高要求的用例。

![Actions _ Overview   Tech Requirements Check](https://github.com/user-attachments/assets/89eb287f-e840-4ea6-8f0c-d3277fd5c941)

### 成本

在标准 GitHub 托管运行器上运行的 Actions 对公共仓库免费，自托管运行器对所有仓库免费。

对于私有仓库，GitHub 根据 [每分钟费率](https://docs.github.com/zh/billing/managing-billing-for-github-actions/about-billing-for-github-actions#per-minute-rates) 收费。成本就是作业运行的分钟数乘以每分钟费率。

> [!TIP]
> GitHub 始终将作业运行时间向上舍入到最接近的分钟。例如，如果你的作业运行 61 秒，GitHub 将收取 2 分钟的费用。

根据你的计划，你有一定数量的免费分钟数和存储空间。如果超过这些限制，将收取额外使用费。

| 计划 | 存储 | 分钟数（每月）|
|------|---------|-------------------| 
| GitHub Team | 2 GB | 3,000 |
| GitHub Enterprise Cloud | 50 GB | 50,000 |

> [!NOTE]
> 这些分钟数仅适用于标准运行器（不包括更大的运行器）。
> 以上值适用于 `ubuntu-latest` 运行器。
> `windows-latest` 的成本是 2 倍（25k 免费）
> `macos-latest` 的成本是 10 倍（5k 免费）。
> 日志和作业摘要不计入存储使用量。

![alt text](/assets/screenshots/Screenshot%202024-08-12%20at%2010.33.53 AM.png)

## 使用自托管运行器自动扩展 (ARC)

你可以使用特定标签接收的 webhook 事件，自动增加或减少环境中自托管运行器的数量。

* [使用自托管运行器自动扩展](https://docs.github.com/zh/actions/hosting-your-own-runners/managing-self-hosted-runners/autoscaling-with-self-hosted-runners)
* [actions-runner-controller](https://github.com/actions/actions-runner-controller)

## 开发者工作流：编写、测试、调试

编写工作流文件就像在仓库的 `.github/workflows` 目录中创建一个 `.yml` 文件一样简单。

要测试工作流文件，你需要将其推送到仓库并导航到 Actions 选项卡以查看工作流运行的状态。

工作流运行完成后，你可以查看每个步骤的日志以了解发生了什么。

## GitHub CLI

GitHub CLI 将 GitHub 带到终端。它还预装在所有 GitHub 运行器上！

如果你需要快速执行 GitHub 任务，这是最简单的方法！

<details>
  <summary>在 issue 上评论</summary>

```yml hljs
on:
  issues:
    types:
      - opened
jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - run: gh issue comment $ISSUE --body "感谢你提交这个 issue！"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE: ${{ github.event.issue.html_url }}
```
</details>

有关 gh cli 可用扩展的列表，请参阅主题 [`gh-extension`](https://github.com/topics/gh-extension)。

[安装](https://cli.github.com/)
[手册](https://cli.github.com/manual/)
[在工作流中使用 GitHub CLI](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/using-github-cli-in-workflows)

## VS Code 扩展

有一个 VS Code 扩展提供语法高亮、智能感知等功能！这是编写工作流时的必备工具。

[GitHub Actions 扩展](https://marketplace.visualstudio.com/items?itemName=GitHub.vscode-github-actions)

![alt text](/assets/screenshots/vscode-extension-1.png)

## Copilot

GitHub Copilot 是一个 AI 配对程序员，可以帮助你更快、更轻松地编写代码。在编写 GitHub Actions 工作流时非常有用。利用补全或聊天功能来获取编写工作流的帮助。

[GitHub Copilot](https://copilot.github.com/)

## Actions 喜欢 JavaScript

编写 actions 最流行的语言之一是 JavaScript。这是因为它易于上手并且有很多社区支持。

### GitHub Actions 工具包

GitHub Actions 工具包提供了一组包，使创建 actions 更容易。

* [Actions 工具包](https://github.com/actions/toolkit?tab=readme-ov-file#readme)
* [创建 JavaScript action](https://docs.github.com/zh/actions/creating-actions/creating-a-javascript-action)

## Github-script

此 action 可以轻松在工作流中快速编写使用 GitHub API 和工作流运行上下文的脚本。GitHub Actions 工具包已预装并可在你编写的脚本中使用。

<details>
  <summary>欢迎首次贡献者</summary>

```yml hljs
on: pull_request_target

jobs:
  welcome:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            // 获取 PR 创建者创建的所有 issue 列表
            // 参见: https://octokit.github.io/rest.js/#pagination
            const creator = context.payload.sender.login
            const opts = github.rest.issues.listForRepo.endpoint.merge({
              ...context.issue,
              creator,
              state: 'all'
            })
            const issues = await github.paginate(opts)

            for (const issue of issues) {
              if (issue.number === context.issue.number) {
                continue
              }

              if (issue.pull_request) {
                return // 创建者已经是贡献者
              }
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `**欢迎**，新贡献者！

                请确保你已阅读我们的 [贡献指南](CONTRIBUTING.md)，我们期待尽快审查你的 Pull Request ✨`
            })
```
</details>

## 表达式

你可以使用表达式在工作流文件中以编程方式设置环境变量并访问上下文。表达式可以是文字值、对上下文的引用或函数的任意组合。你可以使用运算符组合文字、上下文引用和函数。

### 文字

你可以使用布尔值、null、数字或字符串数据类型。

<details>
  <summary>文字示例</summary>

```yml hljs
env:
  myNull: ${{ null }}
  myBoolean: ${{ false }}
  myIntegerNumber: ${{ 711 }}
  myFloatNumber: ${{ -9.2 }}
  myHexNumber: ${{ 0xff }}
  myExponentialNumber: ${{ -2.99e-2 }}
  myString: Mona the Octocat
  myStringInBraces: ${{ 'It''s open source!' }}
```
</details>

### 运算符

<details>
  <summary>运算符示例</summary>

```
运算符    描述
( )      逻辑分组
[ ]      索引
.        属性解引用
!        非
<        小于
<=       小于或等于
>        大于
>=       大于或等于
==       等于
!=       不等于
&&       与
||       或
```
</details>

> [!TIP]
> 你可以使用三元运算符 `condition ? true : false` 作为 `${{ condition && true || false }}`。

[表达式](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions)

### 函数

你可以使用函数来转换数据或执行操作。

* [contains](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#contains) - 包含
* [startswith](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#startswith) - 以...开头
* [endsWith](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#endswith) - 以...结尾
* [format](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#format) - 格式化
* [join](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#join) - 连接
* [toJson](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#tojson) - 转为 JSON
* [fromJson](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#fromjson) - 从 JSON 解析
* [hashFiles](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#hashfiles) - 文件哈希

### 状态检查函数

* [success](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#success) - 成功
* [always](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#always) - 总是
* [cancelled](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#cancelled) - 已取消
* [failure](https://docs.github.com/zh/actions/writing-workflows/choosing-what-your-workflow-does/expressions#failure) - 失败
